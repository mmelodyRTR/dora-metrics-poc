name: Fake Deploy (POC)

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Version / tag to deploy (e.g. v1.2.3)"
        required: true
        type: string

permissions:
  contents: write

env:
  DEPLOYED_VERSION_FILE: .deployment/deployed_version.txt

jobs:
  fake-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Ensure deployment state directory exists
        run: |
          mkdir -p "$(dirname "${DEPLOYED_VERSION_FILE}")"

      - name: Read previously deployed version
        id: previous
        run: |
          if [ -f "${DEPLOYED_VERSION_FILE}" ]; then
            PREV_VERSION=$(cat "${DEPLOYED_VERSION_FILE}")
            echo "Previously deployed version: ${PREV_VERSION}"
          else
            PREV_VERSION=""
            echo "No previously deployed version found (first deploy)."
          fi

          echo "previous_version=${PREV_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Fake deploy
        run: |
          CURRENT_VERSION="${{ inputs.release_tag }}"
          echo "ðŸš€ Fake deploying version: ${CURRENT_VERSION}"
          echo "â„¹ï¸ Previous version was: ${{ steps.previous.outputs.previous_version }}"

          # here is where you'd call Helm / kubectl in a real workflow
          # for now we just echo
          echo "Pretending to roll out ${CURRENT_VERSION} to our 'cluster'"

      - name: Write newly deployed version to file
        run: |
          CURRENT_VERSION="${{ inputs.release_tag }}"
          echo "${CURRENT_VERSION}" > "${DEPLOYED_VERSION_FILE}"
          echo "Wrote deployed version '${CURRENT_VERSION}' to ${DEPLOYED_VERSION_FILE}"

      - name: Commit and push deployment state
        run: |
          # Only commit if there are changes (e.g. version actually changed or first run)
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

            git add "${DEPLOYED_VERSION_FILE}"
            git commit -m "Fake deploy: set deployed version to ${{ inputs.release_tag }}"
            git push
            echo "Pushed updated deployed version to repository."
          else
            echo "No changes to commit."
          fi

      - name: Show final state (for debugging)
        run: |
          echo "===== Deployment state file ====="
          cat "${DEPLOYED_VERSION_FILE}"
          echo "================================="
          echo "Previous version: ${{ steps.previous.outputs.previous_version }}"
          echo "Current version : ${{ inputs.release_tag }}"
